//# sourceMappingURL=data:application/json;base64,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
function log() {  
  let args = Array.prototype.slice.call(arguments)
  args.unshift('rmb')
  console.log.apply(null, args)
}
log('v0.2')
if (chrome.management) {  
  chrome.extension.onMessage.addListener(function (request, sender, sendResponse) {  
    let tab = sender.tab
    if (request.open) {  
      chrome.tabs.create({  
        index: tab.index + 1, 
        url: request.url, 
        selected: true, openerTabId: tab.id
      })
    } else if (request.duplicate) {  
      chrome.tabs.duplicate(tab.id)
    } else if (request.close) {  
      chrome.tabs.remove(tab.id)
    } else if (request.gotoLeftTab || request.gotoRightTab) {  
      chrome.tabs.query({  
        currentWindow: true
      }, function (tabs) {  
        let n = tabs.length
        let index = tab.index + (request.gotoLeftTab ? -1 : 1)
        if (index < 0) index = n - 1; else if (index >= n) index = 0
        chrome.tabs.update(tabs[index].id, {  
          active: true
        })
      })
    } else {  
      log('unknown request', request)
    }
  })
} else {  
  const lmb = 0, mmb = 1, rmb = 2
  const openTime = 140
  const waitTime = 300
  const minDelta = 32
  let active = false
  let pressTime = 0
  let down = [  
    false, false, false
  ]
  let eatRmb = false
  let rocket = false
  let showingMenu = false
  let targetUrl
  let timer
  let startX, deltaX
  let startY, deltaY
  function stopEvent(e) {  
    e.preventDefault()
    e.stopPropagation()
  }
  function execute(opts) {  
    chrome.runtime.sendMessage(opts)
  }
  function openLink(url) {  
    execute({  
      open: true, url
    })
  }
  function showContextMenu() {  
    log('show-context-menu ')
    showingMenu = true
    fetch('http://127.0.0.1:64727').then(function (r) {
    })
  }
  function closeTab() {  
    execute({  
      close: true
    })
  }
  function duplicateTab() {  
    execute({  
      duplicate: true
    })
  }
  function goBack() {  
    log('go-back')
    history.back()
  }
  function gotoLeftTab() {  
    log('goto-left-tab')
    execute({  
      gotoLeftTab: true
    })
  }
  function gotoRightTab() {  
    log('goto-right-tab')
    execute({  
      gotoRightTab: true
    })
  }
  function is_rmb_down(e) {  
    return e.buttons & 4 != 0
  }
  function mousedown(e) {  
    log('mousedown', e, e.button, {  
      down
    })
    clearTimeout(timer)
    if (!(e.altKey || e.ctrlKey || e.shiftKey)) {  
      if (e.button == lmb && down[rmb]) {  
        stopEvent(e)
        eatRmb = true
        rocket = true
      }
    }
    down[e.button] = true
  }
  function mouseup(e) {  
    clearTimeout(timer)
    log('mouseup', e.button, {  
      active, targetUrl, showingMenu
    })
    if (!(e.altKey || e.ctrlKey || e.shiftKey)) {  
      if (e.button == rmb) {  
        if (eatRmb) {  
          if (rocket) {  
            rocket = false
            if (active) {  
              duplicateTab()
            }
          }
          eatRmb = false
        } else if (!down[lmb]) {  
          stopTimer()
          let delta = e.timeStamp - pressTime
          log('delta', delta, {  
            deltaX, deltaY
          })
          let adx = Math.abs(deltaX), ady = Math.abs(deltaY)
          if (adx > minDelta || ady > minDelta) {  
            if (adx > ady) {  
              if (deltaX < 0) {  
                goBack()
              } else {  
                gotoRightTab()
              }
            } else {  
              if (deltaY < 0) {  
                duplicateTab()
              } else {  
                closeTab()
              }
            }
          } else {  
            if (delta < openTime && targetUrl) {  
              openLink(targetUrl)
            } else {  
              showContextMenu()
            }
          }
          stopEvent(e)
        }
      }
    }
    down[e.button] = false
    pressTime = 0
  }
  function mousemove(e) {  
    if (active) {  
      deltaX = e.x - startX
      deltaY = e.y - startY
      log({  
        deltaX, deltaY, startX, startY
      })
    }
  }
  function stopTimer() {  
    window.removeEventListener('mousemove', mousemove, true)
    clearTimeout(timer)
  }
  function startTimer(e) {  
    clearTimeout(timer)
    active = true
    timer = setTimeout(timeout, waitTime)
    startX = e.x
    startY = e.y
    deltaX = 0
    deltaY = 0
    window.addEventListener('mousemove', mousemove, true)
  }
  function timeout() {  
    log('timeout')
    stopTimer()
    active = false
  }
  function contextmenu(e) {  
    log('context-menu', showingMenu)
    stopTimer()
    let sel = window.getSelection()
    if (sel.toString()) {  
      log('have selection', sel, 'node', sel.focusNode, 'target', e.target)
      let selNode = sel.focusNode
      let target = e.target
      if (selNode == target || selNode.parentElement == target) {  
        log('click on selection')
        showingMenu = true
      }
    }
    if (showingMenu) {  
      showingMenu = false
      eatRmb = true
      active = false
      return 
    }
    pressTime = e.timeStamp
    targetUrl = ''
    active = true
    stopEvent(e)
    for (let el of e.path) {  
      if (el instanceof HTMLAnchorElement) {  
        if ('href' in el) {  
          let url = ('' + el.href).trim()
          if (url && 
          !url.startsWith('javascript:') && 
          !url.startsWith('tel:') && 
          !url.startsWith('mailto:')) {  
            log('link ' + url)
            targetUrl = url
          }
        }
        return 
      }
    }
    startTimer(e)
  }
  window.addEventListener('mousedown', mousedown, true)
  window.addEventListener('mouseup', mouseup, true)
  window.addEventListener('contextmenu', contextmenu, true)
}