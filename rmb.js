//# sourceMappingURL=data:application/json;base64,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
function log() {  
  let args = Array.prototype.slice.call(arguments)
  args.unshift('rmb')
  console.log.apply(null, args)
}
log('v0.2')
if (chrome.management) {  
  chrome.extension.onMessage.addListener(function (request, sender, sendResponse) {  
    let tab = sender.tab
    if (request.open) {  
      chrome.tabs.create({  
        index: tab.index + 1, 
        url: request.url, 
        selected: true, openerTabId: tab.id
      })
    } else if (request.duplicate) {  
      chrome.tabs.duplicate(tab.id)
    } else if (request.close) {  
      chrome.tabs.remove(tab.id)
    } else if (request.gotoLeftTab || request.gotoRightTab) {  
      chrome.tabs.query({  
        currentWindow: true
      }, function (tabs) {  
        let n = tabs.length
        let index = tab.index + (request.gotoLeftTab ? -1 : 1)
        if (index < 0) index = n - 1; else if (index >= n) index = 0
        chrome.tabs.update(tabs[index].id, {  
          active: true
        })
      })
    } else {  
      log('unknown request', request)
    }
  })
} else {  
  const lmb = 0, mmb = 1, rmb = 2
  const openTime = 140
  const waitTime = 300
  const minDelta = 16
  let active = false
  let pressTime = 0
  let down = [  
    false, false, false
  ]
  let showingMenu = false
  let targetUrl
  let timer
  let startX, lastX, sumX, deltaX
  let startY, lastY, sumY, deltaY
  function stopEvent(e) {  
    e.preventDefault()
    e.stopPropagation()
  }
  function execute(opts) {  
    chrome.runtime.sendMessage(opts)
  }
  function openLink(url) {  
    execute({  
      open: true, url
    })
  }
  function showContextMenu() {  
    log('show-context-menu ')
    showingMenu = true
    fetch('http://127.0.0.1:64727').then(function (r) {
    })
  }
  function closeTab() {  
    execute({  
      close: true
    })
  }
  function duplicateTab() {  
    execute({  
      duplicate: true
    })
  }
  function goBack() {  
    log('go-back')
    history.back()
  }
  function gotoLeftTab() {  
    log('goto-left-tab')
    execute({  
      gotoLeftTab: true
    })
  }
  function gotoRightTab() {  
    log('goto-right-tab')
    execute({  
      gotoRightTab: true
    })
  }
  function refresh() {  
    location.reload()
  }
  function mousedown(e) {  
    log('mousedown', e, e.button, {  
      down
    })
    down[e.button] = true
  }
  function mousemove(e) {  
    log('mousemove')
    if (active) {  
      let x = e.x, y = e.y
      deltaX = x - startX
      deltaY = y - startY
      sumX += Math.abs(x - lastX)
      sumY += Math.abs(y - lastY)
      lastX = x
      lastY = y
      log({  
        deltaX, deltaY, startX, startY
      })
    }
  }
  function mouseup(e) {  
    log('mouseup', e.button, {  
      active, targetUrl, showingMenu
    })
    if (active && e.button == rmb && !(e.altKey || e.ctrlKey || e.shiftKey)) {  
      stop()
      let delta = e.timeStamp - pressTime
      log('delta', delta, {  
        deltaX, deltaY, sumX, sumY
      })
      let adx = Math.abs(deltaX), ady = Math.abs(deltaY)
      if (sumX > minDelta || sumY > minDelta || adx > minDelta || ady > minDelta) {  
        let k = .75
        if (sumX > sumY) {  
          log('kx', sumX / adx, adx, sumX)
          if (sumX > 0 && adx / sumX < k) {  
            goBack()
          } else {  
            if (deltaX < 0) {  
              gotoLeftTab()
            } else {  
              gotoRightTab()
            }
          }
        } else {  
          log('ky', sumY / ady, ady, sumY)
          if (sumY > 0 && ady / sumY < k) {  
            refresh()
          } else {  
            if (deltaY < 0) {  
              duplicateTab()
            } else {  
              closeTab()
            }
          }
        }
      } else {  
        if (delta < openTime && targetUrl) {  
          openLink(targetUrl)
        } else {  
          showContextMenu()
        }
      }
      stopEvent(e)
    }
    down[e.button] = false
  }
  function stop() {  
    if (active) {  
      active = false
      window.removeEventListener('mousemove', mousemove, true)
    }
  }
  function start(e, capture) {  
    active = true
    pressTime = e.timeStamp
    startX = e.x
    startY = e.y
    lastX = startX
    lastY = startY
    deltaX = 0
    deltaY = 0
    sumX = 0
    sumY = 0
    if (capture) {  
      window.addEventListener('mousemove', mousemove, true)
    }
  }
  function cursorAtSelection(e) {  
    let sel = window.getSelection()
    if (sel.toString()) {  
      log('have selection', sel, 'node', sel.focusNode, 'target', e.target)
      let selNode = sel.focusNode
      let target = e.target
      if (selNode == target || selNode.parentElement == target) {  
        log('click on selection')
        return true
      }
    }
  }
  function getLinkUnderCursor(e) {  
    for (let el of e.path) {  
      if (el instanceof HTMLAnchorElement) {  
        if ('href' in el) {  
          let url = ('' + el.href).trim()
          if (url && 
          !url.startsWith('javascript:') && 
          !url.startsWith('tel:') && 
          !url.startsWith('mailto:')) return url
        }
      }
    }
  }
  function contextmenu(e) {  
    log('context-menu', showingMenu)
    stop()
    if (showingMenu || cursorAtSelection(e)) {  
      showingMenu = false
      active = false
      return 
    }
    stopEvent(e)
    targetUrl = ''
    let url = getLinkUnderCursor(e)
    if (url) {  
      log('link ' + url)
      targetUrl = url
      start(e, false)
      return 
    }
    start(e, true)
  }
  window.addEventListener('mousedown', mousedown, true)
  window.addEventListener('mouseup', mouseup, true)
  window.addEventListener('contextmenu', contextmenu, true)
}